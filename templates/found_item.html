{% extends "base.html" %}

{% block title %}Report Found Item - Lost & Found{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h3 class="card-title mb-0"><i class="fas fa-check-circle text-success"></i> Report Found Item</h3>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="foundItemForm">
                    <div class="mb-3">
                        <label for="image" class="form-label">Item Photo *</label>
                        <input type="file" class="form-control" id="image" name="image" accept="image/*" required>
                        <div class="form-text">Upload a clear photo of the found item</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="label" class="form-label">Item Description *</label>
                        <input type="text" class="form-control" id="label" name="label" required>
                        <div id="ai-suggestion" class="form-text text-info" style="display: none;">
                            <i class="fas fa-robot"></i> AI Suggestion: <span id="predicted-label"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="found_location" class="form-label">Where did you find it? *</label>
                        <input type="text" class="form-control location-input" id="found_location" name="found_location" 
                               placeholder="e.g., Central Park, New York" required>
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="detectFoundLocationBtn">
                            <i class="fas fa-crosshairs"></i> Use Current Location
                        </button>
                        <input type="hidden" id="found_lat" name="found_lat">
                        <input type="hidden" id="found_lon" name="found_lon">
                    </div>
                    
                    <div class="mb-3">
                        <label for="found_date_time" class="form-label">When did you find it? *</label>
                        <input type="datetime-local" class="form-control" id="found_date_time" name="found_date_time" required>
                    </div>
                    
                    <hr>
                    <h5><i class="fas fa-paper-plane"></i> Submit to Owner (Optional)</h5>
                    
                    <div class="mb-3">
                        <label for="submit_to_phone" class="form-label">Owner's Phone Number</label>
                        <input type="tel" class="form-control" id="submit_to_phone" name="submit_to_phone" 
                               placeholder="Enter if you know the owner">
                    </div>
                    
                    <div class="mb-3">
                        <label for="submit_location" class="form-label">Submission Location</label>
                        <input type="text" class="form-control location-input" id="submit_location" name="submit_location" 
                               placeholder="Where you handed over the item">
                        <button type="button" class="btn btn-outline-secondary btn-sm mt-2" id="detectSubmitLocationBtn">
                            <i class="fas fa-crosshairs"></i> Use Current Location
                        </button>
                        <input type="hidden" id="submit_lat" name="submit_lat" value="0">
                        <input type="hidden" id="submit_lon" name="submit_lon" value="0">
                    </div>
                    
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-check-circle"></i> Report Found Item
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('detectFoundLocationBtn').addEventListener('click', function() {
    getCurrentLocation(function(lat, lon) {
        if (lat && lon) {
            document.getElementById('found_lat').value = lat;
            document.getElementById('found_lon').value = lon;
            document.getElementById('found_location').value = `Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        } else {
            alert('Unable to detect your location. Please enter manually.');
        }
    });
});

document.getElementById('detectSubmitLocationBtn').addEventListener('click', function() {
    getCurrentLocation(function(lat, lon) {
        if (lat && lon) {
            document.getElementById('submit_lat').value = lat;
            document.getElementById('submit_lon').value = lon;
            document.getElementById('submit_location').value = `Location: ${lat.toFixed(4)}, ${lon.toFixed(4)}`;
        } else {
            alert('Unable to detect your location. Please enter manually.');
        }
    });
});

// AI prediction for image
document.getElementById('image').addEventListener('change', async function(e) {
    const file = e.target.files[0];
    if (file) {
        const formData = new FormData();
        formData.append('image', file);
        
        try {
            const response = await fetch('/predict-label', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            
            if (result.predicted_label && result.predicted_label !== 'unknown') {
                document.getElementById('predicted-label').textContent = 
                    `${result.predicted_label} (${(result.confidence * 100).toFixed(1)}% confidence)`;
                document.getElementById('ai-suggestion').style.display = 'block';
                
                // Auto-fill if label is empty
                const labelInput = document.getElementById('label');
                if (!labelInput.value) {
                    labelInput.value = result.predicted_label;
                }
            }
        } catch (error) {
            console.error('Error getting AI prediction:', error);
        }
    }
});
</script>
{% endblock %}
